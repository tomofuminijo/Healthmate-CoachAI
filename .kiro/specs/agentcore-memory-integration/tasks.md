# AgentCore Memory統合 - 実装計画

## 実装タスク

- [x] 1. 依存関係の更新とメモリリソースの準備
  - requirements.txtにbedrock-agentcore[strands-agents]パッケージを追加
  - AgentCore Memoryリソースを作成してメモリIDを取得
  - .bedrock_agentcore.yamlにメモリ設定を追加
  - _要件: 1.2, 1.3, 1.4, 3.1, 3.2_

- [ ]* 1.1 依存関係の単体テストを作成
  - パッケージインストール状況の検証テスト
  - _要件: 1.4_

- [x] 2. AgentCoreMemorySessionManagerの統合
  - bedrock_agentcore.memory.integrations.strands からの適切なインポート
  - AgentCoreMemoryConfigクラスの設定
  - 既存のStrandsエージェント初期化コードの更新
  - _要件: 1.1, 5.1, 5.2_

- [ ]* 2.1 メモリセッション管理のプロパティテスト
  - **プロパティ1: メモリセッション管理の一貫性**
  - **検証対象: 要件 1.1**

- [ ]* 2.2 JWT処理のプロパティテスト
  - **プロパティ6: JWT処理の一貫性**
  - **検証対象: 要件 5.2**

- [x] 3. セッションIDとactor_IDの処理実装
  - ペイロードからのセッションID抽出ロジック
  - JWTトークンからのactor_ID抽出の改善
  - セッションID長さ検証（33文字以上）の実装
  - _要件: 5.1, 5.2, 5.3, 5.4_

- [ ]* 3.1 セッションID要件のプロパティテスト
  - **プロパティ5: セッションID要件の遵守**
  - **検証対象: 要件 5.3**

- [ ]* 3.2 ペイロード処理のプロパティテスト
  - **プロパティ7: ペイロード処理の堅牢性**
  - **検証対象: 要件 5.4**

- [x] 4. 既存セッション管理コードの置き換え
  - グローバル変数ベースの_session_contextの削除
  - _get_memory_session関数の更新
  - invoke_health_coach関数でのAgentCoreMemorySessionManager使用
  - _要件: 1.1, 2.1, 2.2_

- [ ]* 4.1 セッション分離のプロパティテスト
  - **プロパティ2: セッション分離の保証**
  - **検証対象: 要件 2.3**

- [ ]* 4.2 ユーザー情報永続性のプロパティテスト
  - **プロパティ3: ユーザー情報の永続性**
  - **検証対象: 要件 2.4**

- [x] 5. エラーハンドリングとフォールバック機能の実装
  - メモリリソースエラー時のフォールバック動作
  - セッション作成失敗時のリトライ機構
  - JWT処理エラー時のデフォルト処理
  - _要件: 4.5, 5.5_

- [ ]* 5.1 エラーハンドリングのプロパティテスト
  - **プロパティ8: エラー時のフォールバック動作**
  - **検証対象: 要件 5.5**

- [ ]* 5.2 エラー処理適切性のプロパティテスト
  - **プロパティ10: エラーハンドリングの適切性**
  - **検証対象: 要件 4.5**

- [x] 6. 既存MCP機能の保持確認
  - list_health_toolsツールの動作確認
  - health_manager_mcpツールの動作確認
  - メモリ統合後の機能テスト
  - _要件: 1.5_

- [ ]* 6.1 MCP機能保持のプロパティテスト
  - **プロパティ4: MCP機能の保持**
  - **検証対象: 要件 1.5**

- [x] 7. テストスクリプトの更新
  - manual_test_agent.pyでのメモリ機能テスト追加
  - manual_test_deployed_agent.pyでのセッション継続性テスト
  - 同じセッションIDでの複数回会話テストの実装
  - _要件: 4.1, 4.2, 4.3_

- [ ]* 7.1 メモリ操作正確性のプロパティテスト
  - **プロパティ9: メモリ操作の正確性**
  - **検証対象: 要件 4.4**

- [x] 8. チェックポイント - すべてのテストが通ることを確認
  - すべてのテストが通ることを確認し、ユーザーに質問があれば対応する

- [x] 9. デプロイと統合テスト
  - 更新されたエージェントのデプロイ
  - フロントエンドとの統合テスト
  - セッション継続性の実際の動作確認
  - _要件: 2.1, 2.2, 2.3, 2.4_

- [x] 10. 最終検証とドキュメント更新
  - 「私の名前はジョニーです」→「私の名前は何ですか？」テストの実行
  - セッション管理機能の動作確認
  - README.mdやSETUP.mdの更新（必要に応じて）
  - _要件: 2.1, 2.2_

- [x] 11. 最終チェックポイント - すべてのテストが通ることを確認
  - すべてのテストが通ることを確認し、ユーザーに質問があれば対応する